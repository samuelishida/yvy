<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script> <!-- Biblioteca do Leaflet para heatmap -->
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <title>Mapa de Desmatamento</title>
    <style>
        /* Faz o mapa preencher toda a tela */
        html, body {
            height: 100%;
            margin: 0;
        }
        #map {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>

<script>
    // Inicializa o mapa com visualização centrada no Brasil
    var map = L.map('map', {
        zoomControl: true  // Inclui o controle de zoom no mapa
    }).setView([-15.7801, -47.9292], 4);

    // Adiciona camada de mapa do OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Grupo de marcadores para clusterização
    var markers = L.markerClusterGroup();

    // Função para carregar dados dinamicamente conforme a área do mapa
    function loadMapData(bounds) {
        const ne = bounds.getNorthEast();
        const sw = bounds.getSouthWest();

        // Chama a API passando as coordenadas do bounding box para filtrar os dados
        fetch(`http://127.0.0.1:5000/data?ne_lat=${ne.lat}&ne_lng=${ne.lng}&sw_lat=${sw.lat}&sw_lng=${sw.lng}`)
            .then(response => response.json())
            .then(data => {
                console.log('Dados recebidos:', data); // Log dos dados recebidos

                let heatData = [];
                data.forEach(item => {
                    heatData.push([item.lat, item.lon, 0.5]); // O terceiro valor é a intensidade

                    // Cria um círculo no mapa para cada ponto de desmatamento
                    let marker = L.circleMarker([item.lat, item.lon], {
                        radius: 6,
                        color: item.color,
                        fillColor: item.color,
                        fillOpacity: 0.6
                    }).bindPopup(`<b>${item.name}</b><br>Coordenadas: ${item.lat}, ${item.lon}`);

                    markers.addLayer(marker);
                });

                // Limpa marcadores antigos antes de adicionar novos
                markers.clearLayers();

                // Adiciona o grupo de marcadores ao mapa
                map.addLayer(markers);

                // Adiciona o heatmap ao mapa
                L.heatLayer(heatData, { radius: 20, blur: 15, maxZoom: 10 }).addTo(map);
            })
            .catch(error => console.error('Erro ao buscar os dados:', error));
    }

    // Carrega dados ao mover ou aplicar zoom no mapa
    map.on('moveend', function () {
        const bounds = map.getBounds();
        loadMapData(bounds);
    });

    // Carrega dados iniciais
    loadMapData(map.getBounds());

    // Ajusta o tamanho do mapa ao redimensionar a janela do navegador
    window.addEventListener('resize', function () {
        map.invalidateSize();
    });

    // Adiciona a legenda ao mapa
    var legend = L.control({position: 'bottomright'});

    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info legend');
        var labels = [
            {color: '#308703', label: 'Vegetação Nativa'},
            {color: '#ffff00', label: 'Desmatamento até 2000'},
            {color: '#ff9600', label: 'Desmatamento Recente'}
        ];

        labels.forEach(item => {
            div.innerHTML += `<i style="background:${item.color}; width: 18px; height: 18px; display: inline-block; margin-right: 5px;"></i>${item.label}<br>`;
        });

        return div;
    };

    legend.addTo(map);
</script>

</body>
</html>